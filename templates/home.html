{% extends 'base.html' %}

{% block title %}Home Page{% endblock %}


{% block nav %}

<form class="d-flex" role="search">
    <div class="dropdown ms-auto">
        <button class="btn btn-outline-primary dropdown-toggle" type="button" data-bs-toggle="dropdown"
            aria-expanded="false">
            {{ user.name }}
        </button>
        <ul class="dropdown-menu dropdown-menu-end p-3 shadow" style="min-width: 250px;">
            <li><strong>Name:</strong> {{ user.name }}</li>
            <li><strong>Email:</strong>{{ user.email }}</li>

            <li class="mt-3 d-flex justify-content-between px-3">
                <a href="{{ url_for( 'main_routes.EditProfile' ) }}" class="btn btn-sm btn-warning">Edit</a>
                <a href="{{ url_for( 'main_routes.ViewProfile' ) }}" class="btn btn-sm btn-info text-white">View</a>
            </li>
            <li>
                <hr class="dropdown-divider">
            </li>
            <li><a class="dropdown-item text-danger" href="{{ url_for( 'main_routes.Logout' ) }}">Logout</a></li>
        </ul>
    </div>
</form>
{% endblock %}


{% block body %}

{% with messages = get_flashed_messages( with_categories = true ) %}
{% if messages %}
{% for category , message in messages %}
<div class="alert alert-danger alert-dismissible fade show d-flex align-items-center mb-0" role="alert">
    <span class="fs-4 me-2">⚠️</span>
    <div>
        {{ message }}
    </div>
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
</div>
{% endfor %}
{% endif %}
{% endwith %}

<div class="container my-5 py-3">
    {% if ( l == 0 ) %}
    <div class="alert alert-info text-center py-4 rounded-3 shadow-sm" role="alert">
        <h4 class="alert-heading display-6 mb-3"><i class="bi bi-info-circle me-2"></i>No Previous Parkings Yet!</h4>
        <p class="lead mb-4">It looks like you haven't booked any parking spots with us. Start your hassle-free parking
            experience today!</p>
        <hr>
        <a href="{{ url_for( 'main_routes.BookPage' ) }}" class="btn btn-primary btn-lg rounded-pill shadow-sm">
            <i class="bi bi-bookmark-fill me-2"></i>Book Your First Spot
        </a>
    </div>
    {% else %}
    <h2 class="text-center mb-4 display-5 fw-bold text-dark">Your Parking History</h2>
    <div class="table-responsive shadow-sm rounded-3 overflow-hidden">
        <table class="table table-striped table-hover align-middle mb-0">
            <thead class="table-dark">
                <tr>
                    <th scope="col">S.No</th>
                    <th scope="col">Reservation Id</th>
                    <th scope="col">Location</th>
                    <th scope="col">Vehicle No</th>
                    <th scope="col">Reserved</th>
                    <th scope="col">Released</th>
                    <th scope="col">Price per hr</th>
                    <th scope="col">Action</th>
                </tr>
            </thead>
            <tbody>
                {% for row in result %}
                <tr>
                    <th scope="row">{{ loop.index }}</th>
                    <td>{{ row.id }}</td>
                    <td>{{ row.location }}</td>
                    <td>{{ row.vehicle_number }}</td>
                    <td>{{ row.reserved_time }}</td>
                    <td>{{ row.Released_time if row.Released_time else 'Not Released' }}</td>
                    <td>{{ row.price_per_hour }}₹</td>
                    <td>
                        {% if row.button == 1 %}
                        <form method="POST" action="{{ url_for('main_routes.ParkIn') }}">
                            <input type="hidden" name="id" value="{{ row.id }}">
                            <input type="hidden" name="reserved_time"
                                value="{{ row.reserved_time.strftime('%Y-%m-%d %H:%M:%S') if row.reserved_time else '' }}">
                            <button type="submit" class="btn btn-primary btn-sm rounded-pill shadow-sm px-3">
                                <i class="bi bi-car-front-fill me-1"></i>Park In
                            </button>
                        </form>

                        {% elif row.button == 2 %}
                        <form method="POST" action="{{ url_for('main_routes.Release') }}">
                            <input type="hidden" name="flag" value="False">
                            <input type="hidden" name="id" value="{{ row.id }}">
                            <input type="hidden" name="price" value="{{ row.price_per_hour }}">
                            <input type="hidden" name="reserved_time"
                                value="{{ row.reserved_time.strftime('%Y-%m-%d %H:%M:%S') if row.reserved_time else '' }}">
                            <button type="submit" class="btn btn-success btn-sm rounded-pill shadow-sm px-3">
                                <i class="bi bi-box-arrow-right me-1"></i>Park Out
                            </button>
                        </form>

                        {% elif row.button == 3 %}
                        <button class="btn btn-secondary btn-sm rounded-pill disabled px-3">
                            <i class="bi bi-check-circle-fill me-1"></i>Over
                        </button>

                        {% else %}
                        <span class="text-danger">Invalid time data</span>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% endif %}

    {% if l > 0 %}
    <h2 class="text-center mt-5 mb-4 display-6 fw-bold text-dark">Book Again? Quick Picks</h2>
    <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4 justify-content-center">
        {% for row in quick_book %}
        <div class="col">
            <div class="card h-100 shadow-sm border-0 rounded-4">
                <div class="card-body p-4">
                    <h5 class="card-title text-primary mb-3 fw-bold">
                        <i class="bi bi-geo-alt-fill me-2"></i>{{ row.location }}
                    </h5>
                    <ul class="list-unstyled mb-4 text-muted">
                        <li><i class="bi bi-car-front-fill me-2"></i><strong>Vehicle:</strong> {{ row.vehicle_number }}
                        </li>
                        <li><i class="bi bi-cash-stack me-2"></i><strong>Price/hr:</strong> {{ row.price_per_hour }} ₹
                        </li>
                        <li><i class="bi bi-calendar-check-fill me-2"></i><strong>Last Reserved:</strong> {{
                            row.reserved_time if row.reserved_time else 'N/A' }}</li>
                    </ul>
                    <form method="POST" action="{{ url_for( 'main_routes.BookingPage' ) }}">
                        <input type="hidden" name="lot_id" value="{{ row.parking_lot_id }}">
                        <input type="hidden" name="price" value="{{ row.price_per_hour }}">
                        <button type="submit" class="btn btn-primary w-100 rounded-pill shadow-sm">
                            <i class="bi bi-arrow-clockwise me-2"></i>Book This Spot Again
                        </button>
                    </form>
                </div>
            </div>
        </div>
        {% endfor %}
        <div class="col d-flex align-items-stretch">
            <div
                class="card h-100 shadow-sm border-0 rounded-4 bg-light d-flex justify-content-center align-items-center p-4">
                <div class="text-center">
                    <i class="bi bi-plus-circle-fill text-secondary display-4 mb-3"></i>
                    <h5 class="card-title fw-bold text-dark mb-3">Explore All Parking Options</h5>
                    <p class="card-text text-muted">Can't find your preferred spot? Discover new locations and book a
                        fresh parking.</p>
                    <a href="{{ url_for( 'main_routes.BookPage' ) }}"
                        class="btn btn-outline-primary rounded-pill shadow-sm mt-3">
                        <i class="bi bi-search me-2"></i>Find New Parking
                    </a>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

</div>

{% endblock %}